name: Fetch BigBasket Product Data

on:
  workflow_dispatch:

jobs:
  fetch-products:
    runs-on: ubuntu-latest

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_TARGET_USER_ID: ${{ secrets.USER_ID }}

    steps:
      # âœ… Checkout code
      - name: Checkout repo
        uses: actions/checkout@v3

      # âœ… Cache Python + Playwright dependencies
      - name: Cache pip & Playwright
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            deps-${{ runner.os }}-

      # âœ… Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      # âœ… Install Python packages
      - name: Install dependencies
        run: pip install -r requirements.txt

      # âœ… Install Playwright browsers (chromium only)
      - name: Install Chromium via Playwright (cached)
        run: |
          PLAYWRIGHT_BROWSERS_PATH=$HOME/.cache/ms-playwright \
          python -m playwright install chromium

     

      # âœ… Fetch session cookie from Supabase
      - name: Fetch session data from Supabase
        run: python fetch_from_supabase.py

      # âœ… Convert session to Playwright format
      - name: Convert bb.json for Playwright
        run: python convert_bbjson.py

      # âœ… Run the BigBasket scraper
      - name: Run BigBasket scraper
        run: |
          PLAYWRIGHT_BROWSERS_PATH=$HOME/.cache/ms-playwright \
          python bb_scraper.py

      # âœ… Upload output
      - name: Commit and push product_data.json
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          mkdir -p public_data
          cp product_data.json public_data/product_data.json
          git add public_data/product_data.json
          git commit -m "ðŸ”„ Update public BigBasket product data"
          git push
